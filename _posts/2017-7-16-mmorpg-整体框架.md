---
layout:     post                    # 使用的布局（不需要改）
title:      多人在线游戏项目              # 标题 
subtitle:     #副标题
date:       2017-7-17              # 时间
author:     co                      # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - 项目
---

这是我们实际开发的一个多人在线角色扮演类游戏的整体框架。该游戏类似吃鸡，但pk不是射击，而是互相打斗。通过匹配会进入战斗场景，进行战斗。框架主要进程分为下面五个。
- db
- gate
- login
- hall
- fight

这个架构跟之前讲架稍有不同。我们这里所有的客户端消息会先发送到gate，gate来继续转发。包括登录验证，也是先经过gate，转发给login，然后进行后续操作。

#### gate
这里是网络数据转发的地方。也包括心跳检测和一些过滤操作。
#### login
这个是我们登录验证的地方。我们的登录表现是这样：
- 先输入帐号密码进行登录
- 创建玩家角色
- 进入到主地图

具体是如下图所示 有些连线没有画出
![](https://gitee.com/whatplane/resource/raw/master/img/xx_20190621113833-min.png)
- 圆形表示节点进程
- 方形表示节点内的服务

登录消息首先发送给gate，gate转发给auth，auth分配一个服务svr处理帐号和角色的生成。之后通知hall，hall会为每一个玩家生成一个agent，然后把消息转发给一个服务svr处理，svr之后又通知agent。agent会把玩家身上的数据都加载，之后通知gate，也就是告诉gate，玩家分配的agent的地址，这样下次gate收到消息会直接发送给agent处理。当然agent也会通知match服务，即匹配服务，查看是否正在战斗，如果是战斗那么进入战斗场景。最后auth会返回登录响应给gate。我们的scene_mgr管理多个hall_sene服务，每一个代表着服务器的一个场景。一开始就会分配一个场景进入。
#### hall
hall里面包括了除了战斗外的所有模块。主要有场景中的实体管理，匹配，好友，聊天，签到，等等各种模块。每个玩家对应一个agent，里面处理所有系统玩法。
#### fight
fight主要是处理战斗场景里面的所有内容。包括场景中的实体管理，技能，移动等等。当匹配成功后，会把对应的玩家放入一个fight中，也就是一个fight可以认为就是一个房间。所有的战斗中的消息处理，都通过gate节点转发给fight节点。
#### db
db主要使用redis和mysql。负责所有的数据处理工作。接收其他节点的数据请求。
#### 业务逻辑
关于业务逻辑。我这里说的是比如技能，buff，各种模块。我们的实现是每个玩家身上带多个管理器，比如技能管理器，buff管理器等等。技能的实现是把技能划分为不同的类型和子类型。同时也会把技能产生的效果划分为不同的类型。针对不同的技能，实现不同的类。
#### 总结 
关于游戏业务处理，实质我们只有两类进程，一类处理战斗场景相关的，一类处理非战斗的游戏模块。如果要实现水平扩展，只需要添加一个节点，作为中心节点。专门管理这两类进程就可以了。这样每个玩家通过中心节点分配到对应的游戏进程即可。
#### 结束