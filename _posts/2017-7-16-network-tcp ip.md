---
layout:     post                    # 使用的布局（不需要改）
title:      tcp协议              # 标题 
subtitle:     #副标题
date:       2017-7-17              # 时间
author:     co                      # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - network
---
## tcp协议

![](https://gitee.com/whatplane/resource/raw/master/img/wz_20190315161643-min.png)

![](https://gitee.com/whatplane/resource/raw/master/img/wx_20190317092613-min.png)
- source port 和 destination port 是源端口和目的端口
- sequence number 是序列号，主要用于tcp的segment。
- ack number 是确认号。主要是接受方告诉发送方数据已经到达。
- window size是接收方告诉发送方，我的接收窗口的大小，目的是告诉发送方对发送速率做出调整，即流量控制。
- 另外有几个位 分别是 SYN FIN ACK 后面再解释。

## 重发和滑动窗口
- tcp是可靠协议。可靠的第一条就是保证数据一定会到达。所以有ack确认机制。也就是发送者发送tcp片出去，则会等待接收方返回ack确认，这样发送者才会继续发送。如果没有收到接收方的ack确认，发送方就会重发数据。那每次发送后应该等待多久呢？等太久的话，可能tcp片早就丢失了，如果等待的时间太短，很可能tcp片还每到达。其实是根据rtt（round trip time）来决定。也就是不断的统计一个个消息来回需要的时间，通过一定的算法来确定一个合理的等待超时。这个超时也是动态变化的，以适应网络状态的变化。

- 但是如果总是发送-等待-发送，这样效率肯定不行。所以其实tcp发送是一次性发送多个tcp片，然后等待接受方的ack确认的。但是这样会有顺序问题。因为网络是不确定的，后发的tcp片可能比先发送的早到达接收方。tcp用滑动窗口来解决这个问题。

![](https://gitee.com/whatplane/resource/raw/master/img/zj_20190315170939.png)
红色框代表滑动窗口。这里讲述滑动窗口的基本过程。
- 发送方窗口左边表示已经发送出去，而且收到ack的tcp片段。窗口右边表示还未发送的tcp片段。方框中间绿色的表示已经发送出去，而且已经收到ack的片段，4代表已经发送出去，但是还没有收到ack确认。这样就导致方框一直停留在这个内核，不会发送新的片段出去。直到收到4的ack确认，滑动窗口才会向右边移动，发送新的片段。另外普通情况下，如果滑动窗口的片段 4 5 6都已经发送出去，但是只有4收到了ack那么窗口会直接向右移动，把7纳入。
- 接收方的窗口左边是已经接收，而且发送了ack的。**方框中是期望接收的片段**。这里绿色表示已经接收了的片段，但是4还没有收到。只有等待4达到了，窗口才会右移。

通过这种方式提高了发送效率，又保证的接收方是顺序接收的。当然这里的ack确认不是单独发送的。也就是有**累计ack**的概念。发送方如果发送了4 5 6片段，接收方只需要发送7，发送方就知道数据已经发送成功。有时候接收方还会故意延迟发送ack，就是为了少发ack，提供效率。

## 流量控制
window size是接收方告诉发送方，我的接收窗口的大小，目的是告诉发送方对发送速率做出调整，即流量控制
## 拥塞控制
重发和滑动窗口基本保证了在应用层把数据交给tcp协议即可。tcp会保证不丢失和有序。拥塞的来源是如果路由器因为有大量的ip包需转发，处理不来就会丢弃一些。但是tcp发现把丢弃了，就会不断的重发，这样就导致更多的丢失，进入恶性循环。拥塞主要是要让发送方控制发送频率。这个跟tcp头中window size作用一样。最终的拥塞控制窗口和advtise window（他的大小就是window size）一起决定。拥塞控制的基本原理是：发送的速率慢慢增长，发现丢包了，就速度减慢，然后又重新慢慢加速。也就是说，加速到一定时刻，发现丢包了，就开始降低发送速率，没有丢包就让你快速发送ip包。**最终的tcp的速度是综合考量 流量控制 和 拥塞控制得出的**



## 对比udp协议
udp数据格式
![](https://gitee.com/whatplane/resource/raw/master/img/wx_20190317093045-min.png)
udp是不可靠协议。但是速度快。主要用于流媒体这些。如果在游戏应用中使用。会有几个问题需要注意
- udp可能中途丢失。本身没有重发机制。
- udp没有顺序的保证。
- udp没有流量控制。


## 结束
