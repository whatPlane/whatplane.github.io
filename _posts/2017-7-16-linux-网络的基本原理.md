---
layout:     post                    # 使用的布局（不需要改）
title:      网络数据传递               # 标题 
subtitle:     #副标题
date:       2017-7-16              # 时间
author:     co                      # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - 网络
---
## 网络的基本分层
网络按照功能划分为链路层，网络层，传输层，应用层。以太网帧的主要包括三个类型：ip arp rapr。

![](https://gitee.com/whatplane/resource/raw/master/img/wz_20190315183915-min.png)

## 数据的流动过程
在链路层的网络主要以太网协议和wifi网络协议。本质上不同网络能够通讯，是因为路由器能够识别解析不同的frame格式。假设有两个网络通讯。我们讨论的目标是从 199.14.15.14发送消息给199.14.160.22。我们这里讨论的是c类网络。子网掩码是255.255.255.0.
![](https://gitee.com/whatplane/resource/raw/master/img/zj_20190315100008-min.png)
每台主机或者路由器都有自己的路由表。里面记录了一些条目。条目主要是指定了不同的网络，应该通过哪个网卡接口转发。一般最后一行表示默认情况下的转发。可以通过 route查看本机的路由表
下面是14主机的路由表。iface是本机的网口接口。
![](https://gitee.com/whatplane/resource/raw/master/img/zi_20190315101226.png)

这里面的内容主要有两行
- 如果目标ip在第一行表示的网络内，那么直接发给目标ip
- 如果不是，那么发送消息给路由器中 ip是199.14.151.20的网卡。

数据的发送主要是通过frame的形式。frame的头部带有源mac和目的mac地址。mac地址主要是用于局域网通讯。刚才的讨论说直接发送给指定的ip，本质上需要知道mac地址的。这可以通过查找一个映射表了解。而arp协议目的就是建立mac地址和ip地址的映射的。
> arp协议建立映射表的基本流程是这样：某主机a广播询问"目标ip对应的mac地址是多少"，然后目标ip会回复a主机。具体是某台主机局域网内广播一个frame，frame的头部信息中就指明了负载数据（payload）的类型是arp，数据部分包括了自己的ip和mac地址。目标主机回复询问主机，其他主机收到信息后更新自己的映射表。其他主机也做类似的广播，最终每台主机上有整个局域网的ip和mac的映射表。

当frame发送给路由器后，路由器根据目标ip查找自己主机上保存的映射表，来决定下一转发目标。这里路由是通过把frame里面ip数据报(datagram)解析得到目标ip的。当确定下一个目标后，修改frame头部的mac地址。再转发给局域网。

> 路由器带有多个网卡，每个网卡属于不同的局域网。

## 路由表的生成
我们刚刚说了主机有路由表可以查询来决定下一个目标。路由表是怎么生成的呢。可以想象也是动态生成的。因为网络环境是可以变化的，有的主机下线了，有的路由器损坏之类的。在自治系统内比如说 中国移动，中国联通，内部是通过rip协议生成更新路由表的。而自治系统之间又通过其他协议生成相关的路由表。理解到这就可以了。

## 关于ip地址
- 传统的划分法如下 这种我们平时通过ip地址就可以判断他所属网络的类别。比如 199.33.3.66 就知道是c类。
![](https://gitee.com/whatplane/resource/raw/master/img/xx_20190316095300-min.png)

- 新的划分是方法叫做 CIDR（Classless Interdomain Routing）.类似192.43.43.4/24。这里24表示子网掩码高位全1的个数。这里网络号是192.43.43.0，主机范围是0-255.
- ip主机号全0 只能表示某网络，不能表示主机。
- 广播
  - 目标IP是255.255.255.255表示发送本网络所有主机
  - 目标ip的主机号全1，表示发送到某网络所有主机

- 回环地址
  - loop back是一个网络设备。当目标地址是127.x.x.x的时候，数据不会发出，而是发送给这个网络设备，最后又返回上层应用。
  - 当目标地址是本机的网卡地址时，数据也不会发出，同样会发送给这个网络设备，最终返回上层应用。




## 结束