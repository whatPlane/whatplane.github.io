---
layout:     post                    # 使用的布局（不需要改）
title:      网络消息的基本传递原理               # 标题 
subtitle:     #副标题
date:       2017-7-16              # 时间
author:     co                      # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - 网络
---
## 网络的基本分层
网络按照功能划分为链路层，网络层，传输层，应用层。

## 数据的流动过程
在链路层的网络主要以太网协议和wifi网络协议。本质上不同网络能够通讯，是因为路由器能够识别解析不同的frame格式。假设有两个网络通讯。我们讨论的目标是从 199.14.15.14发送消息给199.14.160.22。我们这里讨论的是c类网络。子网掩码是255.255.255.0.
![](https://gitee.com/whatplane/resource/raw/master/img/zj_20190315100008-min.png)
每台主机或者路由器都有自己的路由表。里面记录了一些映射关系。可以通过 route查看本机的路由表
下面是14主机的路由表
![](https://gitee.com/whatplane/resource/raw/master/img/zi_20190315101226.png)

这里面的内容主要有两行
- 如果目标ip在第一行表示的网络内，那么直接发给目标ip
- 如果不是，那么发送消息给路由器中 ip是199.14.151.20的网卡。

数据的发送主要是通过frame的形式。frame的头部带有源mac和目的mac地址。mac地址主要是用于局域网通讯。刚才的讨论说直接发送给指定的ip，本质上需要知道mac地址的。这可以通过查找一个映射表了解。而arp协议目的就是建立mac地址和ip地址的映射的。
> arp协议建立映射表的基本流程是这样：某台主机局域网内广播一个frame，frame的头部信息中就指明了负载数据（payload）的类型是arp，数据部分包括了自己的ip和mac地址。其他主机更新映射表。同时其他主机也做类似的广播，最终每台主机上有整个局域网的ip和mac的映射表。

当frame发送给路由器后，路由器根据目标ip查找自己主机上保存的映射表，来决定下一转发目标。这里路由是通过把frame里面ip数据报(datagram)解析得到目标ip的。当确定下一个目标后，修改frame头部的mac地址。再转发给局域网。

> 路由器带有多个网卡，每个网卡属于不同的局域网。

## 路由表的生成
我们刚刚说了主机有路由表可以查询来决定下一个目标。路由表是怎么生成的呢。可以想象也是动态生成的。因为网络环境是可以变化的，有的主机下线了，有的路由器损坏之类的。在自洽系统内比如说 中国移动，中国联通，内部是通过rip协议生成更新路由表的。而自洽系统之间又通过其他协议生成相关的路由表。理解到这就可以了。

## 结束